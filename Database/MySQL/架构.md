# MySQL架构

MySQL主要分为Server层和引擎层，Server层包括连接器、查询缓存、分析器、优化器、执行器。同时还有一个日志模块（binlog），这个日志模块所有引擎都可以用。

引擎层是插件式的，目前主要包括MyISAM，InnoDB，Memory等。

查询语句的执行流程：权限校验（如果缓存命中）-> 查询缓存 -> 分析器 -> 优化器 -> 权限校验 -> 执行器 -> 存储引擎

更新语句的执行流程：分析器 -> 权限校验 -> 执行器 -> 存储引擎 -> redolog（prepare状态） -> binlog -> redolog（commit状态）

![MySQL架构](images/mysql架构.png)

## 连接器

身份认证和权限相关。连接器负责跟客户端建立连接、获取权限、维持和管理连接。连接命令：
    mysql -h ip -P port -u user -p

一个用户成功建立连接后，即使用管理员账号对用户权限做了修改，也不会影响已经存在连接的权限。修改完成后，只有新建的连接才会使用新的权限设置。连接完成后，如果没有后续的动作，这个连接处于空闲状态，可以用show processlist命令查看。如果太长时间没有动静，连接器就会自动将它断开，时间由参数wait_timeout控制，默认是8小时。

## 查询缓存

MySQL8.0 版本直接将查询缓存的功能删除了。

MySQL拿到一个查询请求后，会先查询缓存，之前是不是执行过这条语句。执行过的语句及其结果可能会以key-value的形式，被直接缓存在内存中。key是查询的语句，value是查询的结果。如果不在查询缓存中，就会继续后面的执行阶段。执行完成后，执行结果会被存入查询缓存中。查询缓存的实效非常频繁，只要有对一个表的更新，这个表上所有的查询缓存都会被清空。

## 分析器

MySQL没有命中缓存就会进入分析器，分析器主要用来分析SQL语句的作用。分为两步：

1. 词法分析，一条SQL语句由多个字符串构成，首先要提取关键字，提出查询的表，提出字段名，提出查询条件等。
2. 语法分析，主要判断输入的SQL是否正确，是否符合MySQL语法。

## 优化器

按照MySQL认为的最优执行方案去执行，比如多个索引时该如何选择索引，多表关联时该如何选择关联顺序等。

## 执行器

选择了执行方案，MySQL就要开始执行SQL语句。执行前会校验该用户是否有执行权限，如果没有就直接返回错误信息，如果有权限就会去调用存储引擎的接口，返回执行结果。

### MySQL执行顺序

1. FROM：首先选择出需要从数据库中执行哪张表；
2. ON：执行“JOIN”语句时，“ON”用于确定表的绑定关系，通过“ON”条件产生临时中间表；
3. WHERE：基于指定的条件对记录进行筛选；
4. GROUP BY：将数据划分成多个组别；
5. HAVING：使用“HAVING”子句筛选满足特定条件的组别；
6. SELECT：选择需要显示的字段；
7. DISTINCT：筛选重复数据，去除重复记录；
8. ORDER BY：对数据进行排序，按照指定的顺序显示记录；
9. LIMIT：进行结果限定，选择显示的记录条数。

## SQL优化

### 慢SQL定位与分析

1. 慢SQL查询日志
2. EXPLAIN语句

### 索引、表结构和SQL优化

1. 索引优化：创建原则、索引覆盖、最左前缀匹配原则。
2. 表结构优化：选择合适的字段类型、避免冗余字段、合理使用范式和反范式设计等。
3. SQL优化：避免使用SELECT *、尽量使用具体字段、使用连接查询代替子查询、合理使用分页查询、批量操作等。

### 架构优化

1. 读写分离：将读操作和写操作分离到不同的数据库实例，提升数据库的并发处理能力。
2. 分库分表：将数据分散到不同的数据表中，降低单表的数据量，提升查询效率。
3. 数据冷热分离：根据数据的访问频率，将数据分为冷数据和热数据，冷数据一般存储在低成本、低性能的介质中，热数据一般存储在高性能的介质中。
4. 缓存机制：使用Redis等缓存中间件，将热点数据缓存到内存中，减轻数据库压力。

### 其他手段

1. 连接池配置：配置合理的数据库连接池（如连接池大小、超时时间等），能够有效的提升数据库的连接效率，避免频繁连接造成的开销。
2. 硬件配置
