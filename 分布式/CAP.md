# CAP定理

CAP定理又被称作布鲁尔定理，它指出对于一个分布式计算系统来说，不可能同时满足以下三点：

- 一致性（Consistency）：等同于所有节点访问同一份最新的数据副本。
- 可用性（Availability）：每次请求都能获取到非错的响应，但是不保证获取的数据为最新数据。
- 分区容错性（Partition tolerance）：以实际效果而言，分区相当于对通信的时限要求。系统如果不能再时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在C和A之间做出选择。

## 分区容错性

两个节点分处分区两侧，允许至少一个节点更新导致状态不一致，即丧失了C特性。为了保证状态一致性而将一个节点置为不可用，则丧失了A特性。除非两个节点可以互相通信，才能保证C特性和A特性，但是这样又丧失了P特性。

P指的是分区容错性，分区现象产生后需要容错，容错是指在A与C之间选择。如果分布式系统没有分区现象（没有出现不一致不可用情况）或本身就没有分区，既然没有分区就没有分区容错性P。

无论设计的系统是AP还是CP，如果没有出现不一致不可用，则系统就处于CA状态。

P的体现前提是得有分区情况存在。

## 常用CAP框架

### Eureka

Eureka保证了可用性，实现了最终一致性。

Eureka所有节点都是平等的，所有数据都是相同的，且Eureka可以相互交叉注册。

Eureka Client使用内置轮询负载均衡器去注册，有一个检测间隔时间，如果在一定时间内没有收到心跳，才会移除该节点注册信息；如果客户端发现当前Eureka不可用，会切换到其他的节点，如果所有的Eureka都不可用，Eureka Client会使用最后一次数据作为本地缓存。以上每种设计都不具备一致性的特性。

### Zookeeper

强一致性。

Zookeeper在选举leader时会停止服务，只有成功选举leader后才能提供服务，选举时间较长；内部投票机制要求获取半数以上的投票才能成为leader，否则重新投票。Zookeeper健康检查一般使用tcp长链接，内部网络抖动时或者对应节点阻塞时都会变成不可用。

### Consul

强一致性。

Consul注册时候只有过半的节点都写入成功才认为注册成功；leader挂掉时，重新选举期间整个Consul不可用，保证了强一致性但牺牲了可用性。
