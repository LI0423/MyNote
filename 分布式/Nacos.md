# Nacos

## 基本概念

### Namespace（命名空间）

Namespace是同一地域内，用于进行租户粒度配置隔离的逻辑空间。其常用场景之一是区分不同环境的配置，例如将开发测试环境和生产环境的资源（如配置、服务）进行隔离。

### Group（分组）

Group是Nacos中组织配置的一个维度，可以将相关的配置集归为一组。默认情况下，分组为DEFAULT-GROUP。通过分组可以对配置进行分类管理。

### Configuration（配置）

这里的配置涵盖了系统配置的编辑、存储、分发、变更管理、历史版本管理、变更审计等所有与配置相关的活动。

### Service（服务）

在Nacos中，Service代表一个可被发现和调用的微服务。一个Service下可能包含多个服务实例，每个实例具有自己的IP地址、端口号等信息。

### Instance（实例）

Instance是服务的具体实例，包含了服务的具体信息，如IP、端口号、服务名、集群名等。客户端启动时会讲当前服务的这些信息封装为一个Instance对象，然后向Nacos服务器进行注册。Nacos通过管理这些Instance对象，实现对服务实例的健康检查、负载均衡等功能。

### Metadata（元数据）

Nacos中的元数据是对Nacos数据（如配置和服务）的描述信息。从作用范围来看，分为服务级别的元信息（如服务版本、权重、融在策略、负载均衡策略、鉴权配置等）、聚群的元信息以及实例的元信息。通过设置服务级别的元数据中的权重，可以实现基于权重的负载均衡；通过设置鉴权配置元数据，可以对服务的访问进行权限控制。

## 架构

### 整体架构

Nacos的架构融合了服务注册发现中心、配置中心、服务管理等功能。主要由Nacos Server和Nacos Client两部分组成。Nacos Server是服务端，负责存储服务实例信息、配置信息等，并提供相关的管理接口；Nacos Client是客户端，集成在应用程序中，负责向Nacos Server注册服务实例、获取配置信息以及与Nacos Server进行通信等操作。

### 组织架构

- configservice：主要用于处理配置信息的增删改查操作。
- namingservice：负责服务注册与发现。客户端通过调用namingservice的相关接口，将自身服务实例信息注册到Nacos Server上，同时服务消费者也通过该组件从Nacos Server获取服务提供者的列表信息，实现服务的发现功能。

### 运行模式

- standalone（单机）模式：适用于测试环境或开发环境。Nacos Server以单节点的形式运行，使用自带的嵌入式数据库Derby来存储数据。
- cluster（集群）模式：适用于生产环境。Nacos Server由多个节点组成集群，节点之间通过特定的协议进行数据同步和协调。通常需要使用外部数据库（如MySQL）来存储数据，以保证多个节点之间数据的统一和可靠。

## 核心功能

- 服务注册：Nacos会通过发送REST请求的方式向Nacos Server注册自己的服务，提供自身的元数据，比如IP地址、端口等信息。Nacos Server接收到注册请求后，会把这些元数据信息存储在一个双层的内存map中。
- 服务心跳：在服务注册后，Nacos Client会维护一个定时心跳来持续通知Nacos Server，说明服务一直处于可用状态，防止被剔除。默认5s发送一次心跳。
- 服务同步：Nacos集群之间会互相同步服务实例，用来保证服务信息的一致性。
- 服务发现：支持基于DNS和基于RPC的服务发现方式。服务消费者（Nacos Client）在调用服务提供者的服务时，会发送一个REST请求给Nacos Server，获取上面注册的服务清单，并且缓存在Nacos Client本地，同时在Nacos Client本地开启一个定时任务，定时拉取服务端最新的注册表信息更新到本地缓存。
- 服务健康检查：Nacos Server会开启一个定时任务，定时检查服务实例的健康状态，如果超过15s没有接收到服务实例的心跳，会将实例的healthy属性置为false，如果超过30s没有接收到服务实例的心跳，会将服务实例从可用服务列表中移除，避免用户请求被发送到该故障实例上。
- 动态配置管理：
  - 配置编辑与存储：可以在Nacos的UI界面上对配置进行编辑，配置信息会被存储在Nacos Server中，支持多种数据格式，如常见的JSON、YAML等。
  - 配置分发与变更管理：当配置发生变更时，Nacos会通过长连接的方式实时推送变更后的配置信息给相关的Nacos Client。Nacos Client接收到配置变更通知后，会自动更新本地的配置。
  - 配置拉取：除了服务端主动推动配置变更外，Nacos Client也可以主动向Nacos Server拉取配置信息。
