# 核心组件详解

## 服务注册与发现中心（Service Register & Discovery Center）

### 注册中心作用

1. 注册（Registration）：服务实例启动，向注册中心注册自己的元数据（如服务器、IP地址、端口、健康状态、版本、标签等）。
2. 注销（Deregistration）：服务实例优雅关闭或崩溃时（通常使用心跳检测），从注册中心注销自己。
3. 发现（Discovery）：服务消费者（或网关）需要调用某个消费者时，向注册中心查询该服务的可用情况。
4. 健康检查（Health Checking）：注册中心定期主动检查或接收服务实例的心跳，标记不健康的实例，确保发现结果可靠。

## API网关（API Gateway）

### 网关作用

1. 统一接入点：所有外部请求首先到达网关，网关再将请求路由到内部相应的微服务实例。
2. 请求路由：根据请求路径、Header、方法、参数等奖请求转发到正确的实例。
3. 协议转换：处理不同协议（HTTP/HTTPS）。
4. 聚合：将内部多个请求的响应聚合成一个响应返回给客户端。
5. 横切关注点处理：
   1. 身份认证与授权：集中验证用户身份（如JWT、OAuth2）和权限（如RBAC），保护后端服务。
   2. SSL/TLS终止：在网关层处理HTTPS解密，减轻后段服务器压力。
   3. 限流（Rate Limiting）：在网关层实施全局或API级别的请求速率限制。
   4. 熔断：监控后段微服务状态，在服务不可用时快速失败，避免级联故障。
   5. 日志记录与监控：在网关层集中记录接口请求日志、时间等内容。
   6. 请求/响应转换：修改请求头、路径、参数等内容。
   7. 灰度发布：根据规则将请求路由到新版本服务。

## 熔断（Circuit Breaker）

### 熔断作用

1. 监控对特定服务使用的失败率、延迟等指标。
2. 当失败率超过特定的阈值时，触发熔断。
3. 在熔断状态下，对目标服务的后续调用会立即失败，不再尝试实际调用（避免资源耗尽）。可以返回预设的降级响应。
4. 经过一段设定的重置时间后，熔断器会进入半开状态，允许少量试探请求通过。如果请求成功，熔断器关闭，恢复正常调用；如果请求失败，熔断器保持开启。

## 限流（Rate Limiting）

### 限流作用

1. 在指定时间窗口内，限制允许通过的请求数量。
2. 超出限制的请求会被立即拒绝，或排队等候（可能导致消息积压）。
3. 可以在不同粒度上实施：全局、服务级别、API端点级别、用户/客户端级别。

### 常用算法

1. 令牌桶算法：
   1. 桶以恒定速率产生令牌。
   2. 请求到达时，需要从桶中取走一个令牌才能被处理。
   3. 桶有容量上限。桶空时，请求会被拒绝。
   4. 允许一定程度的突发流量（桶里有积累的令牌时）。
2. 漏桶算法：
   1. 桶以恒定速率处理请求。
   2. 桶有容量上限。桶满时，请求会被拒绝。
   3. 强制输出恒定速率，平滑突发流量。
3. 固定窗口计数器：简单统计固定时间窗口（如1秒）的请求数量，超出限制请求会被拒绝。窗口边界切换时，可能发生毛刺（如窗口切换时瞬间涌入双倍流量）。
4. 滑动窗口计数器：更精确地限制任意时刻的请求速率，避免固定窗口的边界问题，计算开销大。

## 降级（Fallback/Degradation）

### 降级作用

1. 在发生非核心功能故障（如依赖服务不可用、熔断器打开、限流触发）或系统压力过大，暂时关闭或简化部分非核心业务功能。
2. 提供替代方案：
   1. 返回缓存数据：展示稍旧但可用的数据。
   2. 返回默认值/空值/友好提示：如“推荐功能暂时不可用”。
   3. 调用备用服务：使用功能更简单但更稳定的备份服务。
   4. 简化处理流程：跳过耗时的非必要操作。
3. 目的：牺牲非关键功能的完整性和实时性，确保核心业务流程能够继续运行（如电商下单、支付流程），维持最基本的用户体验和系统稳定性。

### 触发条件

1. 熔断器打开。
2. 限流被触发。
3. 依赖服务调用或失败超时。
4. 系统资源达到阈值。
5. 人工通过配置中心手动触发。

### 与熔断的关系

降级是熔断触发后的一种应对策略。但降级也可以在熔断之外的其他场景（如限流、手动操作）下触发。

## 总结

这些组件在微服务治理中紧密协作，构建一个弹性系统。

1. 注册中心：提供服务实例的动态清单，是服务间通信的基础。
2. 网关：作为外部流量的守门人，集中处理路由、安全、限流、熔断监控等，并将请求转发给通过注册中心发现的健康实例。
3. 熔断器：安装在服务间调用路径上，监控依赖服务的健康状态。一旦检测到持续故障，立即“熔断”对该服务的调用，触发降级，防止故障扩散。
4. 限流器：在网关/服务内部，控制流入的请求速率，防止突发流量压垮服务，是保护系统过载的第一道防线。当限流触发时，也会执行降级（拒绝请求）。
5. 降级：是熔断和限流等保护机制触发后的应对手段，也可是主动策略。它确保在非理想状态下，核心业务仍能够提供有损但可用的服务。
