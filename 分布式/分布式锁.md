# 分布式锁

## Redis分布式锁

### Redis最普通的分布式锁

在Redis里使用SET key value [EX seconds] [PX milliseconds] NX 创建一个key，这样就算加锁。

- NX：表示只有key不存在时才会设置成功，如果此时redis中存在这个key，那么设置失败，返回nil。
- EX seconds：设置key的过期时间，精确到秒级。意思是seconds秒后锁自动释放，别人创建的时候如果发现已经有了就不能加锁了。
- PX milliseconds：同样是设置key的过期时间，精确到毫秒级。

如以下命令：

SET resource_name random_value PX 30000 NX

释放锁就是删除key，一般可以用lua脚本删除，判断value一样才删除。

为什么要用random_value随机值呢？因为如果某个客户端获取到了锁，但是阻塞了很长时间才执行完，超过了设定的过期时间，可能已经自动释放锁了。此时别的客户端获取到了这个锁，要是直接删除key会有问题，所以使用随机值加lua脚本来释放锁。

这种方案不可行。如果是普通的Redis单实例，发生单点故障；如果是普通主从，主从异步复制，主节点挂了，key还没同步到从节点，锁就会丢失。

### RedLock

### Redission
