# HTTP

## 特点

- 灵活可扩展：可以任意添加头字段实现任意功能。
- 可靠传输：因为HTTP协议是基于TCP/IP的，TCP本身就是可靠的传输协议。
- 应用层协议：比FTP、SSH等更通用功能更多，能够传输任意数据。
- 请求-应答：客户端主动发起请求，服务器被动回复请求。
- 无状态：每个请求互相独立、毫无关联，协议不要求客户端或服务器记录请求相关的信息。

## Cookie

cookie是服务器发送到用户浏览器并保存在本地的一小块数据，会在浏览器之后向同一服务器再次发起请求时被携带上，用于告知服务器两个请求是否来自同一浏览器。

## Session

Session可以将用户信息存储在服务器端。

Session维护用户登陆状态的过程：

1. 用户进行登录时，用户提交包含用户名和密码的表单，放入HTTP请求报文中。
2. 服务器验证该用户名和密码。
3. 如果正确则把用户信息保存到Redis中，在Redis中的key称为SessionID。
4. 服务器返回的响应报文的Set-Cookie首部字段包含了这个这个SessionID，客户端收到响应报文之后将该Cookie值存到浏览器中。
5. 客户端之后对同一个服务器进行请求时会包含该Cookie值，服务器收到之后提取出SessionID，从Redis中取出用户信息继续之前的业务操作。

## HTTP报文结构

1. 起始行（start line）：描述请求或响应的基本信息；
2. 头部字段集合（header）：使用key-value形式更详细地说明报文；
3. 消息正文（entity）：实际传输的数据，不一定是纯文本，可以是图片、视频等二进制数据。
4. 起始行和头部字段合称为请求头或响应头，消息正文又称为实体，但与header对应，称为body。
5. 请求行

    请求报文里的起始行也就是请求行，简要描述了客户端想要如何操作服务器端的资源。
    - 请求方法：是一个动词，如GET/POST，表示对资源的操作。
    - 请求目标：通常是一个URI，标记了请求方法要操作的资源。
    - 版本号：表示报文使用的HTTP协议版本。
6. 状态行

    响应报文里的起始行，叫做状态行，服务器的响应状态。
    - 版本号：表示报文使用的HTTP协议版本。
    - 状态码：一个三位数，用代码的形式表示处理的结果，比如200是成功，500是服务器错误。
    - 原因：作为数字状态码补充，是更详细的解释文字，帮助人理解原因。

## 八种请求方法

- GET：获取资源，可以理解为读取或者下载数据。
- HEAD：获取资源的元信息。
- POST：向资源提交数据，相当于写入或上传数据。
- PUT：类似POST。
- DELETE：删除资源。
- CONNECT：建立特殊的连接隧道。
- OPTIONS：列出可对资源实行的方法。
- TRACE：追踪请求-响应的传输路径。

## 响应状态码

- 1xx：提示信息，表示目前是协议处理的中间状态，还需要后续的操作；
- 2xx：成功，报文已经收到并被正确处理；
  - 200 OK 表示一切正常。
  - 204 Not Content 与200基本相同，但响应头后没有body数据。
  - 206 Partial Content 是HTTP分块下载或断点续传的基础，在客户端发送“范围请求”、要求获取资源的部分数据时出现。通常还伴随着头字段“Content-Range”，表示响应报文里body数据的具体范围，供客户端确认。
- 3xx：重定向，资源位置发生变动，需要客户端重新发送请求；
  - 301 Moved Permanently 永久重定向，此次请求的资源已经不存在，需要改用新的URI再次访问。
  - 302 Found 曾经的描述短语是 Moved Temporarily 临时重定向，请求的资源还在，但需要暂时用另一个URI来访问。
  - 304 Not Modified 缓存重定向，表示资源未修改，用于缓存控制，不具有通常的跳转含义。
- 4xx：客户端错误，请求报文有误，服务器无法处理；
  - 400 Bad Request 表示请求报文有错误，但具体是数据格式错误还是URI超长没有明确说。
  - 403 Forbidden 表示服务器禁止访问资源。
  - 404 Not Found 资源在本服务器上未找到，所以无法提供给客户端。
  - 405 Method Not Allowed 不允许使用某些方法操作资源。
  - 406 Not Acceptable 资源无法满足客户端请求的条件，例如请求中文但只有英文。
  - 408 Request Timeout 请求超时，服务器等待了过长的时间。
  - 409 Conflict 多个请求发生了冲突，可以理解为多线程并发时的竞态。
  - 413 Request Entity Too Large 请求报文里body太大。
  - 414 Request-URI Too Long 请求行里的URI太大。
  - 429 Too Many Requests 客户端发送了太多的请求，通常是由于服务器的限连策略。
  - 431 Request Header Fields Too Large 请求头某个字段或总体太大。
- 5xx：服务器错误，服务器在处理请求时内部发生了错误。
  - 500 Internal Server Error 通用错误码。
  - 501 Not Implemented 表示客户端请求的功能还不支持。
  - 502 Bad Gateway 通常是服务器作为网关或者代理时返回的错误码，表示服务器自身工作正常，访问后端服务器时发生了错误。
  - 503 Service Unavailable 表示服务器当前很忙，暂时无法响应服务。

## CDN 内容分发网络

CDN 最核心原则“就近访问”，CDN使用缓存代理技术，把源站的内容逐级缓存到网络的每一个节点上。用户在上网的时候就不直接访问源站，而是访问离他“最近的”一个CDN节点，术语叫“边缘节点”，其实就是缓存了源站内容的代理服务器。

### CDN两个关键组成部分

- 全局负载均衡：简称为GSLB，主要职责是当用户接入网络的时候在CDN专网中挑选出一个“最佳”节点提供服务，解决的是用户如何找到“最近的”边缘节点，对整个CDN网络进行负载均衡。智能调度的依据：看用户的IP地址，查表得知地理位置，找相对最近的边缘节点；看用户所在的运营商网络，找相同网络的边缘节点；检查边缘节点的负载情况，找负载较轻的节点；其他，比如节点的“健康状况”、服务能力、带宽、响应时间等。
- 缓存系统：“命中”就是指用户访问的资源恰好放在缓存系统里可以直接返还给用户；“回源”则相反，缓存里没有，必须用代理回源站取。“命中率”就是命中次数与所有访问次数之比，回源率是回源次数与所有访问次数之比。

## HTTP服务器优化

衡量服务器性能的主要指标：吞吐量（requests per second）、并发数（concurrency）、响应时间（time per request）。

## HTTPS协议

HTTPS是让HTTP先和SSL（Secure Sockets Layer）通信，再由SSL和TCP通信，也就是说HTTPS使用了隧道进行通信。通过使用SSL，HTTPS具有了加密（防窃听）、认证（防伪装）和完整行保护。

### 过程

1. 服务器把自己的公钥登录至数字认证机构。
2. 数字证书机构把自己的私有密钥向服务器的公开密钥部署数字签名并颁发公钥证书。
3. 客户端拿到服务器的公钥证书后，使用数字证书认证机构的公开密钥，向数字证书认证机构验证公钥证书上的数字签名，以确认服务器公钥的真实性。
4. 使用服务器的公开密钥对报文加密后发送。
5. 服务器私有密钥对报文解密。

## 从URL到网页的过程中发生了什么

1. 从浏览器输入指定网页的URL。
2. 浏览器通过DNS协议，获取域名对应的IP地址。
3. 浏览器根据IP地址和端口号，向目标服务器发起一个TCP连接请求。
4. 浏览器在TCP连接上，向服务器发送一个HTTP请求报文，请求获取网页的内容。
5. 服务器收到HTTP请求报文后，处理请求，并返回HTTP响应报文给浏览器。
6. 浏览器收到HTTP响应报文后，解析响应体中的HTML代码，渲染网页的结构和样式，同样根据HTML中的其他资源的URL（如图片、CSS、JS等），再次发起HTTP请求，获取这些资源的内容，直到网页完全加载显示。
7. 浏览器在不需要和服务器通信时，可以主动关闭TCP连接，或者等待服务器的关闭请求。
