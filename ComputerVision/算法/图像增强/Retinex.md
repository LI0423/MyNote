# Retinex

## 名称由来

Retinex是Retina（视网膜）和Cortex（大脑皮层）两个词的合成。强调了颜色感知是视网膜接收光信号和大脑皮层进行复杂处理共同作用的结果。

## 基本假设

基本成像模型：Retinex理论建立在简单的物理模型之上：
$$S(x,y) = R(x,y) * L(x,y)$$

- $S(x,y)$：在图像位置 $(x,y)$ 处观察（感知）到的亮度值（传感器捕获的值）。
- $R(x,y)$：在位置 $(x,y)$ 处物体的反射率。这是物体的固有属性，决定了物体反射多少比例的光以及反射哪些波长的光（即颜色）。理想情况下，$R$ 应该在[0,1]范围内（0表示全吸收，1表示全反射）。
- $L(x,y)$：在位置 $(x,y)$ 处照射到物体上的光照强度。这是光源的属性，可以随空间位置变化（非均匀光照）。

目标：给定观测到的图像 $S$，估计出反射图像 $R$（代表物体本身的颜色和纹理）和光照图像 $L$。Retinex的核心任务就是估计 $R$，因为它被认为包含了物体的“真实”颜色信息，相对不受光照 $L$ 变化的影响。

## 核心思想：颜色恒常性

Retinex理论的核心目标是解释和模拟人类的颜色恒常性现象。什么是颜色恒常性？

现象：在不同的光照条件下，我们感知到的物体的颜色是相对稳定的。

挑战：实际上物体反射到我们眼睛的光的绝对强度和光谱组成是随着光照条件剧烈变化的。相机拍出来的原始照片就明显收到光照颜色的影响。

Retinex的解答：人类视觉系统并不是简单地记录到达视网膜光的绝对量，而是能够分离场景中的光照成分和物体本身的反射属性成分。大脑通过比较场景中不同区域的亮度关系，来推断物体固有的“颜色”（反射率），从而在很大程度上抵消了光照变化的影响。

## 关键原理：相对亮度比较

**物体的颜色感知主要取决于它与周围区域亮度的相对关系，而不是绝对亮度值本身。**

- 局部对比度：大脑更关注相邻区域之间的亮度比值。
- 多尺度处理：颜色恒常性的实现可能涉及在不同空间尺度上比较亮度。小尺度的比较处理细节和纹理，大尺度的比较处理整体光照变化。

## 经典Retinex算法

### 1.路径比较法（Path-wise/Random Path Retinex）

- 思路：对于图像中的每个像素点 $(x,y)$，随机选择一条从图像边界（或其他参考点）到该点的路径。
- 计算：沿着路径计算相邻像素点之间亮度值的比值（通常是某个颜色通道，如R，G，B）。最终，$(x,y)$ 点的反射率估计 $R(x,y)$ 被计算为这条路径上所有比值的乘积（或对数和）。
- 意义：这个乘积（或和）模拟了光从边界传播到目标点时，沿途反射率变化累积的效果（比值相乘），抵消了光照变化（如果光照是平滑变化的，路径上的光照比会接近1）。
- 问题：结果依赖于随机路径的选择，需要多次随机取平均，计算量大；路径选择方式对结果有显著影响。

### 2.中心环绕法/比例处理（Center/Surround Retinex）

- 思路：这是最著名和最实用的Retinex变种。对于每个像素点 $(x,y)$，计算它在一个小的中心区域（通常就是该点本身或极小领域）的亮度与在一个较大的环绕区域（通过高斯模糊模拟）的平均亮度之间的比值。
- 计算：单尺度 Retinex(SSR)：$R(x,y)\approx log(S(x,y)) - log[F(x,y) * S(x,y)]$
  - $F(x,y)$ 是一个低通滤波器（通常是高斯滤波器）的核，&*& 表示卷积。$F(x,y) * S(x,y)$ 就是对图像进行高斯模糊得到的结果，代表了该点周围区域的平均光照估计 $L_{est}(x,y)$。
  - 取对数是为了将乘法关系 $S=R*L$转换为加法关系：$log(S) = log(R) + log(L)$。这样，$log(R) \approx log(S) - log(L_{est})$。
- 多尺度Retinex(MSR)：使用多个不同尺度（不同高斯模糊核大小）的高斯环绕滤波器计算结果，然后将这些结果加权求和。这能同时处理不同尺度的光照变化和细节。
- 带颜色恢复的多尺度Retinex（MSRCR）：经典MSR处理各颜色通道（R，G，B）独立进行，有时会导致颜色失真。MSRCR在MSR结果上引入了颜色恢复步骤（如根据原始图像色彩比例进行恢复），以获得更自然的颜色。
- 优点：计算相对高效，效果直观可见（增强图像，颜色校正，去雾）。
- 缺点：高斯模糊可能导致光晕伪影，特别是在强边缘附近（模糊区域跨越了明暗边界）；参数（高斯核大小、尺度权重）需要调整。

### 3.变分法（Variational Methods）

- 思路：将Retinex问题表述为一个能量最小化问题。定义能量函数包含两项：
  - 数据保真项：要求重建的图像 $R * L$ 尽可能接近观测图像 $S$。
  - 正则化项：利用先验知识约束 $R$ 和 $L$。关键的先验是：
    - 反射图 $R$：具有分段常数特性（同一物体区域反射率变化小），包含锐利的边缘（物体边界）。
    - 光照图 $L$：变化缓慢且平滑（光照通常是空间渐变的），没有锐利边缘。
- 求解：通过优化算法（如梯度下降、迭代重加权最小二乘）最小化能量函数，同时估计出 $R$ 和 $L$。
- 优点：数学框架更严谨，能更好地处理光晕问题（通过显示约束 $L$ 平滑，$R$ 分片光滑），结果通常更优。
- 缺点：计算更复杂；需要精心设计能量函数和正则化项。
