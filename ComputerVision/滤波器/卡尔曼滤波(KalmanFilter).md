# 卡尔曼滤波

## 原理

    一种利用线性系统状态方程，通过系统输入输出观测数据，对系统状态进行最优估计的算法。由于观测数据中包括系统中的噪声和干扰的影响，所以最优估计也可以看作是滤波过程。

### 1.解释

    就是一种聪明的“预测+修正”的办法，用来从带噪声的数据里，尽量估计出真实值。它相信：“对未来的预测 + 现在的观测值，综合一下，能得到更靠谱的估计。”

### 2.处理步骤

#### 1. **预测**

    根据上一个时刻的值，预测当前时刻的值和误差大小。
    比如：
    我预测这帧跳绳 y 坐标在 200 像素
    我预测这帧误差是 ±10 像素

#### 2. **更新**

    拿到当前实际观测值后，根据它和预测值的差距，调整预测值。
    如果观测值离预测很近，说明预测靠谱 → 小改动
    如果观测值离预测很远，说明观测可能有噪声 → 轻信预测，多修正

## 数学公式详解

### 1. **系统模型**

#### 1.1 状态方程（预测模型）

$$
x_t = F_t x_{t-1} + B_t u_t + w_t \quad (w_t \sim \mathcal{N}(0, Q_t))-----（1）
$$

#### 1.2 观测方程（测量模型）

$$
z_t = H_t x_t + v_t \quad (v_t \sim \mathcal{N}(0, R_t))-----（2）
$$

为什么要引入 $w_t$ 和 $v_t$？

对于状态方程（1）来说，大多数实际的控制系统并不是一个严格的线性时变系统，或者系统结构参数的不确定，导致估计的状态值$x_t$存在偏差，而这个偏差值由
过程噪声$w_t$来表征。对于观测方程（2）来说，采集的信号往往是包含噪声及干扰信号的，亦或观测矩阵$H_t$自身的观测偏差，从而导致了测得的实际信号（观测值）
与真实值之间存在一定的偏差，这个量由$v_t$来表征。

---

### 2. **预测阶段（Predict）**

#### 2.1 状态预测

$$
\hat{x}_{t|t-1} = F_t \hat{x}_{t-1|t-1} + B_t u_t
$$

#### 2.2 协方差预测

$$
P_{t|t-1} = F_t P_{t-1|t-1} F_t^T + Q_t
$$

---

### 3. **更新阶段（Update）**

#### 3.1 卡尔曼增益计算

$$
K_t = P_{t|t-1} H_t^T \left( H_t P_{t|t-1} H_t^T + R_t \right)^{-1}
$$

#### 3.2 状态更新

$$
\hat{x}_{t|t} = \hat{x}_{t|t-1} + K_t \left( z_t - H_t \hat{x}_{t|t-1} \right)
$$

#### 3.3 协方差更新

$$
P_{t|t} = (I - K_t H_t) P_{t|t-1}
$$

---

### 4. **符号说明**

| 符号               | 含义                                                        |
|-------------------|-------------------------------------------------------------|
|   $x_t$           | 系统在时刻 $t$ 的状态向量（如位置、速度）                         |
|   $z_t$           | 时刻 $t$ 的观测值                                             |
|   $F_t$           | 状态转移矩阵（描述状态如何随时间变化）                             |
|   $B_t$           | 控制输入矩阵（将控制输入 $u_t$ 映射到状态空间）                    |
|   $u_t$           | 控制输入向量（如加速度指令）                                     |
|   $H_t$           | 观测矩阵（将状态映射到观测空间）                                  |
|   $Q_t$           | 过程噪声协方差矩阵（表示预测模型本身的噪声）                        |
|   $R_t$           | 观测噪声协方差矩阵（表示测量值与真实值之间的差值）                   |
|   $P_{t\|t}$      | 后验估计协方差矩阵（表示系统的不确定程度，在卡尔曼滤波初始化时会很大，随着越来越多的数据注入滤波器中，不确定程度会变小）|
|   $K_t$           | 卡尔曼增益（平衡模型预测与观测值的权重）                           |
|   $I$             | 单位矩阵                                                      |
|   $w_t$           | 过程噪声，协方差为$Q$                                          |
|   $v_t$           | 测量噪声，且为高斯白噪声，协方差为$R$                             |

---

### 5. **匀速模型特例**

#### 5.1 状态向量定义

$$
x = \begin{bmatrix} \text{position} \\ \text{velocity} \end{bmatrix}
$$

#### 5.2 状态转移矩阵

$$
F = \begin{bmatrix}
1 & \Delta t \\
0 & 1
\end{bmatrix}
$$

##### 物理意义

1. 位置更新：新位置 = 原位置 + 速度 x 时间间隔

   对应矩阵元素：$F[0,0] = 1, F[0,1] = \Delta t$

2. 速度更新：假设匀速运动，速度保持不变

   对应矩阵元素：$F[1,0] = 0, F[1,1] = 1$

##### 矩阵相乘过程

$$
\begin{bmatrix}
x_{new} \\
v_{new}
\end{bmatrix}
=
\begin{bmatrix}
1 & \Delta t \\
0 & 1
\end{bmatrix}
\times
\begin{bmatrix}
    x \\
    v
\end{bmatrix}
=
\begin{bmatrix}
    1 · x + \Delta t · v \\
    0 · x + 1 · v
\end{bmatrix}
$$

- 新位置：$x_{new} = x + v · \Delta t$
- 新速度：$v_{new} = v （假设匀速）$

#### 5.3 过程噪声协方差（随机加速度假设）

$$
Q = \sigma_a^2 \begin{bmatrix}
\frac{\Delta t^4}{4} & \frac{\Delta t^3}{2} \\
\frac{\Delta t^3}{2} & \Delta t^2
\end{bmatrix}
$$

##### 物理基础

来自匀速运动模型中的随机加速度
